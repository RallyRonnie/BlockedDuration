<!DOCTYPE html>
<html>
<head>
    <title>BlockedDuration</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://storage.googleapis.com/versions.lumenize.com/v0.7.2/Lumenize-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this,app.iid=null,app.names=[],app.ids=[],app.oids=[],app.owners=[];var ipicker=Ext.create("Ext.Container",{items:[{xtype:"rallyiterationcombobox",fieldLabel:"Choose Iteration",storeConfig:{listeners:{load:function(store,records){}}},listeners:{select:function(combobox){app.iid=combobox.getRecord().get("ObjectID"),app.getSnapshots()},ready:function(combobox){app.iid=combobox.getRecord().get("ObjectID"),app.getSnapshots()}}}]});app.add(ipicker)},getSnapshots:function(){app.mystore=Ext.create("Rally.data.lookback.SnapshotStore",{listeners:{load:function(store,data,success){console.log(data),app.names=[],app.ids=[],app.oids=[],app.owners=[],Ext.Array.each(data,function(myitem){console.log(myitem.get("FormattedID")),app.ids.push(myitem.get("FormattedID")),app.oids.push(myitem.get("ObjectID")),app.names.push(myitem.get("Name")),app.owners.push(myitem.get("Owner"))}),console.log(app.owners),app.calcBlockedTime(data)}},fetch:["FormattedID","Name","Owner","_ValidFrom","_ValidTo","ObjectID","Blocked"],hydrate:["Owner"],autoLoad:!0,find:{_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]},_TypeHierarchy:{$in:["HierarchicalRequirement","Defect"]},Iteration:app.iid,Blocked:!0}})},calcBlockedTime:function(blockedSnapshots){var that=this,snapshots=_.pluck(blockedSnapshots,function(s){return s.data}),granularity="minute",tz="America/Chicago",config={granularity:granularity,tz:tz,workDayStartOn:{hour:8,minute:0},workDayEndBefore:{hour:17,minute:0},validFromField:"_ValidFrom",validToField:"_ValidTo",uniqueIDField:"ObjectID"},start=moment().dayOfYear(0).toISOString(),end=moment().toISOString();console.log(snapshots),tisc=new window.parent._lumenize.TimeInStateCalculator(config),tisc.addSnapshots(snapshots,start,end);var results=tisc.getResults();app.drawGrid(results)},drawGrid:function(data){var hticks=0;app.mytable&&app.mytable.destroy(),app.mytable=Ext.create("Ext.panel.Panel",{title:"Story Block Durations",layout:{type:"table",columns:4},defaults:{bodyStyle:"padding:5px"},width:600,items:[{html:"<B>ID</B>"},{html:"<B>Name</B>"},{html:"<B>Owner</B>"},{html:"<B>Total Duration (Hours)</B>"}]}),Ext.Array.each(data,function(child){var aindex=app.oids.indexOf(child.ObjectID);hticks=child.ticks/60,app.mytable.add([{html:" "+app.ids[aindex]},{html:""+app.names[aindex]},{html:""+app.owners[aindex]},{html:" "+hticks.toFixed(2)}])}),app.add(app.mytable)}});

            Rally.launchApp('CustomApp', {
                name:"BlockedDuration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
